# ğŸ—ºï¸ Floor Plan Wayfinding Analyzer API

Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ (Floor Plans) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø±ÙŠØ§Øª Space Syntax Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ù„ØªØ­Ù„ÙŠÙ„ ÙØ¹Ø§Ù„ÙŠØ© Ø§Ù„ØªÙ†Ù‚Ù„ (Wayfinding).

## ğŸŒ URLs

- **Production API**: https://wfapi.aqeeli.com/
- **Frontend Interface**: https://wfapi.aqeeli.com/
- **API Documentation**: https://wfapi.aqeeli.com/docs
- **GitHub Repository**: https://github.com/ahmmad4242-ai/wayfinding
- **VPS Server**: 77.37.35.25

## âœ¨ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

### 1ï¸âƒ£ ØªØ­Ù„ÙŠÙ„ Space Syntax (Bill Hillier)
- **Axial Line Analysis**: ØªÙˆÙ„ÙŠØ¯ Ø®Ø·ÙˆØ· Ù…Ø­ÙˆØ±ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
- **Integration (Global/Local)**: Ù‚ÙŠØ§Ø³ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…ÙƒØ§Ù†ÙŠ
- **Choice (Betweenness)**: Ù‚ÙŠØ§Ø³ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
- **Connectivity**: Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±Ø§Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª
- **Control Value**: Ù‚ÙŠØ§Ø³ Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø§Ù„Ù…ÙƒØ§Ù†ÙŠØ©

### 2ï¸âƒ£ ØªØ­Ù„ÙŠÙ„ VGA (Visibility Graph Analysis)
- **Isovist Analysis**: ØªØ­Ù„ÙŠÙ„ Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„Ø±Ø¤ÙŠØ© (Michael Benedikt)
- **Mean Depth**: Ù‚ÙŠØ§Ø³ Ø¹Ù…Ù‚ Ø§Ù„Ø±Ø¤ÙŠØ©
- **Visual Integration**: Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ØµØ±ÙŠ
- **Visual Connectivity**: Ø§Ù„ØªØ±Ø§Ø¨Ø· Ø§Ù„Ø¨ØµØ±ÙŠ
- **Grid-based Analysis**: ØªØ­Ù„ÙŠÙ„ Ø´Ø¨ÙƒÙŠ ÙØ¹Ø§Ù„

### 3ï¸âƒ£ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ (Agent-Based Simulation)
- **Pedestrian Movement**: Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø´Ø§Ø©
- **Shortest Path Analysis**: ØªØ­Ù„ÙŠÙ„ Ø£Ù‚ØµØ± Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
- **Decision Points**: ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø­Ø±Ø¬Ø©
- **Movement Heatmaps**: Ø®Ø±Ø§Ø¦Ø· Ø­Ø±Ø§Ø±ÙŠØ© Ù„Ù„Ø­Ø±ÙƒØ©

### 4ï¸âƒ£ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„Ø§ÙØªØ§Øª (Signage Analysis)
- **OCR Arabic/English**: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ØµÙˆØµ Ø§Ù„Ù„Ø§ÙØªØ§Øª
- **Location Detection**: ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù„Ø§ÙØªØ§Øª
- **Visibility Score**: ØªÙ‚ÙŠÙŠÙ… ÙˆØ¶ÙˆØ­ Ø§Ù„Ù„Ø§ÙØªØ§Øª
- **Coverage Analysis**: ØªØ­Ù„ÙŠÙ„ ØªØºØ·ÙŠØ© Ø§Ù„Ù„Ø§ÙØªØ§Øª

### 5ï¸âƒ£ Ø­Ø³Ø§Ø¨ WES Score
- **Wayfinding Effectiveness Score**: 0-100
- **Weighted Components**: Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ø±Ø¬Ø­Ø©
- **Academic Validation**: Ù…Ø¹Ø§ÙŠÙŠØ± Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©
- **Actionable Insights**: ØªÙˆØµÙŠØ§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°

## ğŸ“¦ Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©

### Backend
- **Framework**: FastAPI (Python 3.12)
- **Database**: PostgreSQL 15 + PostGIS
- **Cache**: Redis 7
- **OCR**: Tesseract (Arabic + English)
- **PDF Processing**: pdf2image + Poppler
- **Image Processing**: OpenCV, Pillow, scikit-image
- **Analysis**: NetworkX, NumPy, SciPy
- **Deployment**: Docker + Docker Compose

### Frontend
- **Framework**: Vanilla JavaScript (CDN-based)
- **Styling**: Tailwind CSS
- **HTTP Client**: Axios
- **Icons**: Font Awesome
- **RTL Support**: Full Arabic RTL interface

### Infrastructure
- **Web Server**: Nginx (reverse proxy)
- **DNS**: Cloudflare (proxied with auto-HTTPS)
- **VPS**: Ubuntu 24.04 LTS
- **CI/CD**: Git + GitHub

## ğŸ—ï¸ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©

```
floor-plan-analyzer/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ main.py                 # FastAPI app entry point
â”‚   â”‚   â””â”€â”€ routes/                 # API route handlers
â”‚   â”œâ”€â”€ wayfinding/
â”‚   â”‚   â”œâ”€â”€ space_syntax.py         # Axial line analysis
â”‚   â”‚   â”œâ”€â”€ vga_isovists.py         # VGA + isovist analysis
â”‚   â”‚   â”œâ”€â”€ agent_simulation.py     # Agent-based simulation
â”‚   â”‚   â””â”€â”€ signage_analyzer.py     # Signage OCR & analysis
â”‚   â”œâ”€â”€ analysis/
â”‚   â”‚   â”œâ”€â”€ wes_calculator.py       # WES score calculation
â”‚   â”‚   â””â”€â”€ recommendation_engine.py # Recommendations
â”‚   â””â”€â”€ visualization/
â”‚       â””â”€â”€ heatmap_generator.py    # Heatmap generation
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ index.html                  # Arabic RTL interface
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.py                 # Pydantic Settings
â”œâ”€â”€ migrations/                      # Database migrations
â”œâ”€â”€ docker-compose.yml              # Multi-container orchestration
â”œâ”€â”€ Dockerfile                       # API container image
â””â”€â”€ .env.production                  # Production environment vars
```

## ğŸš€ Installation & Deployment

### Prerequisites
- Docker & Docker Compose
- Git
- Domain with DNS pointing to VPS
- Ubuntu 24.04 LTS (or compatible)

### 1. Clone Repository
```bash
git clone https://github.com/ahmmad4242-ai/wayfinding.git
cd wayfinding
```

### 2. Configure Environment
```bash
cp .env.example .env.production
# Edit .env.production with your settings
nano .env.production
```

### 3. Build & Start Services
```bash
# Build Docker images
docker-compose -f docker-compose.yml build

# Start all services (API, PostgreSQL, Redis)
docker-compose -f docker-compose.yml up -d

# Check container status
docker-compose ps
```

### 4. Setup Nginx (Frontend + API Proxy)
```bash
# Copy nginx configuration
sudo cp deployment/nginx/wfapi.aqeeli.com /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/wfapi.aqeeli.com /etc/nginx/sites-enabled/

# Deploy frontend files
sudo mkdir -p /var/www/wfapi
sudo cp -r frontend/* /var/www/wfapi/

# Test and reload nginx
sudo nginx -t
sudo systemctl reload nginx
```

### 5. Verify Deployment
```bash
# Test API health
curl http://localhost:8000/health
curl https://wfapi.aqeeli.com/health

# Test frontend
curl https://wfapi.aqeeli.com/

# Check Docker logs
docker-compose logs -f fpa_api
```

## ğŸ“– Usage Guide

### Web Interface (Frontend)

1. Ø§ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­: https://wfapi.aqeeli.com/
2. Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù…Ù„Ù floor plan (PDF Ø£Ùˆ ØµÙˆØ±Ø©)
3. Ø£Ø¯Ø®Ù„ Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø±Ø³Ù… (Ù…Ø«Ù„Ø§Ù‹: 50 = 1cm : 50cm)
4. Ø­Ø¯Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø© (Ø§ÙØªØ±Ø§Ø¶ÙŠ: 50)
5. ÙØ¹Ù‘Ù„ Heatmaps Ø¥Ø°Ø§ Ø±ØºØ¨Øª Ø¨Ø°Ù„Ùƒ
6. Ø§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·"
7. Ø§Ù†ØªØ¸Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… (ÙŠØ³ØªØºØ±Ù‚ 2-5 Ø¯Ù‚Ø§Ø¦Ù‚)
8. Ø§Ø·Ù„Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: WES ScoreØŒ RecommendationsØŒ Visualizations
9. Ø­Ù…Ù‘Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (JSON Ø£Ùˆ PDF)

### API Direct Usage (cURL)

#### Upload & Analyze
```bash
curl -X POST https://wfapi.aqeeli.com/api/analyze/wayfinding \
  -F "file=@floor_plan.pdf" \
  -F "scale=50" \
  -F "n_agents=50" \
  -F "enable_heatmaps=true"

# Response:
# {"job_id": "abc123...", "status": "processing"}
```

#### Check Status
```bash
curl https://wfapi.aqeeli.com/api/status/{job_id}

# Response:
# {"status": "completed", "progress": 100}
```

#### Get Results
```bash
curl https://wfapi.aqeeli.com/api/results/{job_id}

# Response: Full analysis results with WES score
```

#### Download Heatmap
```bash
curl https://wfapi.aqeeli.com/api/heatmap/{job_id}/integration \
  -o integration_heatmap.png
```

## ğŸ“Š Data Models

### Analysis Request
```python
{
    "file": "binary_file",           # PDF or image
    "scale": 50,                     # cm per pixel
    "n_agents": 50,                  # agent count
    "enable_heatmaps": true          # generate visualizations
}
```

### Analysis Response
```python
{
    "wes_score": 68.5,               # 0-100
    "space_syntax": {
        "global_integration": 2.45,
        "local_integration": 1.89,
        "choice": 156.3,
        "connectivity": 4.2
    },
    "vga": {
        "mean_depth": 8.7,
        "visual_integration": 3.21,
        "grid_points": 5000
    },
    "agent_simulation": {
        "avg_path_efficiency": 0.78,
        "decision_points": 12,
        "confusion_zones": 3
    },
    "signage": {
        "signs_detected": 8,
        "coverage_score": 65.0,
        "visibility_score": 72.3
    },
    "recommendations": [
        "Add signage at decision point (45, 78)",
        "Improve visibility at zone (120, 150)"
    ]
}
```

## ğŸ”§ Configuration

### Environment Variables (.env.production)
```bash
# Domain
DOMAIN=wfapi.aqeeli.com

# API
API_HOST=0.0.0.0
API_PORT=8000
API_WORKERS=4

# Features
ENABLE_SPACE_SYNTAX=true
ENABLE_VGA=true
ENABLE_AGENT_SIMULATION=true

# VGA Settings
VGA_SAMPLE_LIMIT=5000
VGA_GRID_SPACING=1.0

# Database
POSTGRES_HOST=fpa_database
POSTGRES_PORT=5432
POSTGRES_DB=wayfinding
POSTGRES_USER=wayfinding_user
POSTGRES_PASSWORD=your_secure_password

# Redis
REDIS_HOST=fpa_redis
REDIS_PORT=6379
REDIS_DB=0
```

## ğŸ§ª Testing

### Health Check
```bash
curl https://wfapi.aqeeli.com/health
# Expected: {"status": "healthy"}
```

### API Documentation
Visit: https://wfapi.aqeeli.com/docs

### Sample Files
Use test floor plans in `tests/fixtures/`:
- `simple_office.pdf`
- `complex_building.png`

## ğŸ“ˆ Performance

### Analysis Times (Average)
- Small floor plan (<1000 pixels): ~30s
- Medium floor plan (1000-3000 pixels): ~90s
- Large floor plan (>3000 pixels): ~180s

### Resource Usage
- **Memory**: ~2GB per analysis job
- **CPU**: 4 workers, parallel processing
- **Storage**: ~50MB per analyzed floor plan

### Optimization
- VGA sampling limited to 5000 grid points
- Redis caching for repeated analyses
- PostgreSQL indexing for fast queries

## ğŸ› Troubleshooting

### Issue: Frontend shows connection error
**Solution**: 
```bash
# Verify API_URL in frontend
grep "API_URL" /var/www/wfapi/index.html
# Should be: const API_URL = 'https://wfapi.aqeeli.com';

# If wrong, update it:
cd /root/wayfinding
git pull origin main
cp -r frontend/* /var/www/wfapi/
```

### Issue: Docker container not starting
**Solution**:
```bash
# Check logs
docker-compose logs fpa_api

# Rebuild if needed
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### Issue: Port 8000 already in use
**Solution**:
```bash
# Kill process on port 8000
fuser -k 8000/tcp

# Restart containers
docker-compose restart
```

## ğŸ“ Academic References

1. **Hillier, B., & Hanson, J. (1984)**. *The Social Logic of Space*. Cambridge University Press.
2. **Turner, A. (2001)**. *Depthmap: A program to perform visibility graph analysis*. UCL.
3. **Benedikt, M. L. (1979)**. *To take hold of space: Isovists and isovist fields*. Environment and Planning B, 6(1), 47-65.
4. **Penn, A. (2003)**. *Space Syntax and Spatial Cognition*. Environment and Behavior, 35(1), 30-65.

## ğŸ“ Current Status

### âœ… Completed Features
- âœ… Space Syntax analysis with axial lines
- âœ… VGA with isovist generation
- âœ… Agent-based wayfinding simulation
- âœ… Signage OCR (Arabic + English)
- âœ… WES Score calculation
- âœ… Heatmap visualization
- âœ… JSON/PDF report generation
- âœ… FastAPI backend with 4 workers
- âœ… PostgreSQL + PostGIS + Redis
- âœ… Docker deployment with multi-container
- âœ… Nginx reverse proxy configuration
- âœ… Cloudflare DNS with auto-HTTPS
- âœ… Arabic RTL frontend interface
- âœ… Real-time progress tracking
- âœ… Production deployment at wfapi.aqeeli.com

### ğŸš§ Known Issues
- âš ï¸ Frontend API_URL fix needs to be pulled on VPS (see UPDATE_VPS_INSTRUCTIONS.md)

### ğŸ“‹ Next Steps
1. âœ… Fix frontend API_URL configuration (commit c5c86fb pushed)
2. ğŸ”„ Pull latest code on VPS
3. ğŸ§ª Test file upload with actual floor plan
4. ğŸ“Š Verify WES score calculations
5. ğŸ“– Test report downloads (JSON + PDF)
6. ğŸ¨ Test heatmap generations
7. ğŸ“š Update documentation with usage examples
8. ğŸš€ Performance optimization if needed

## ğŸ‘¨â€ğŸ’» Development

### Local Development
```bash
# Install dependencies
pip install -r requirements.txt

# Run with hot reload
uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000
```

### Add New Analysis Module
1. Create analyzer class in `src/wayfinding/`
2. Register in `src/api/main.py`
3. Add to WES calculation in `src/analysis/wes_calculator.py`
4. Update API routes if needed
5. Write tests in `tests/`

## ğŸ“„ License

MIT License - See LICENSE file for details

## ğŸ¤ Contributing

Contributions welcome! Please:
1. Fork the repository
2. Create feature branch
3. Make changes with tests
4. Submit pull request

## ğŸ“§ Support

- **Issues**: https://github.com/ahmmad4242-ai/wayfinding/issues
- **Discussions**: https://github.com/ahmmad4242-ai/wayfinding/discussions

---

**Last Updated**: 2025-11-08  
**Version**: 1.0.0  
**Status**: ğŸŸ¢ Production Deployment Active
