<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„Ù„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ù„Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª | Academic Wayfinding Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-indigo-900">
                        ğŸ¥ Ù…Ø­Ù„Ù„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ù„Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
                    </h1>
                    <p class="text-gray-600 mt-1">
                        Academic Wayfinding Analysis System | Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
                    </p>
                </div>
                <div class="text-left">
                    <span class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-semibold">
                        v2.0.0 Academic
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <!-- Upload Section -->
        <div class="bg-white rounded-xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                ğŸ“ Ø±ÙØ¹ Ù…Ø®Ø·Ø· Ø§Ù„Ø·Ø§Ø¨Ù‚ | Upload Floor Plan
            </h2>
            
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">
                    Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ù…Ø®Ø·Ø· (PNG, JPG, PDF)
                </label>
                <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.pdf" 
                    class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-indigo-500 transition">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ (Ø¨ÙƒØ³Ù„/Ù…ØªØ±) | Scale (px/m)
                    </label>
                    <input type="number" id="scaleInput" value="100" 
                        class="w-full border border-gray-300 rounded-lg p-3">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø© | Agents Count
                    </label>
                    <input type="number" id="agentsInput" value="100" 
                        class="w-full border border-gray-300 rounded-lg p-3">
                </div>
            </div>

            <div class="mb-6">
                <label class="flex items-center">
                    <input type="checkbox" id="heatmapsCheckbox" checked 
                        class="w-5 h-5 text-indigo-600">
                    <span class="mr-3 text-gray-700">
                        ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© | Enable Heatmaps
                    </span>
                </label>
            </div>

            <button id="analyzeBtn" 
                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-4 px-8 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-lg">
                ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ | Start Academic Analysis
            </button>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="bg-white rounded-xl shadow-xl p-8 mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ | Analysis in Progress
            </h2>
            <div class="mb-4">
                <div class="bg-gray-200 rounded-full h-6 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full transition-all duration-500" 
                        style="width: 0%"></div>
                </div>
            </div>
            <p id="progressMessage" class="text-gray-700 text-center font-semibold"></p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <!-- WES Score Card -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-2xl p-8 text-white mb-8">
                <h2 class="text-3xl font-bold mb-4 text-center">
                    ğŸ“Š Ø¯Ø±Ø¬Ø© ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ | WES Score
                </h2>
                <div class="text-center">
                    <div class="text-7xl font-bold mb-2">
                        <span id="wesScore">--</span><span class="text-4xl">/100</span>
                    </div>
                    <div class="text-2xl mb-2">
                        <span id="wesGrade" class="bg-white text-indigo-900 px-6 py-2 rounded-full"></span>
                    </div>
                    <p id="wesInterpretation" class="text-xl opacity-90"></p>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Space Syntax -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ”— Space Syntax</h3>
                    <p class="text-gray-600 text-sm mb-3">Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…ÙƒØ§Ù†ÙŠ</p>
                    <div class="text-3xl font-bold text-indigo-600" id="ssIntegration">--</div>
                </div>

                <!-- VGA -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ‘ï¸ VGA</h3>
                    <p class="text-gray-600 text-sm mb-3">Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ØµØ±ÙŠ</p>
                    <div class="text-3xl font-bold text-blue-600" id="vgaIntegration">--</div>
                </div>

                <!-- Signage -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸª§ Ø§Ù„Ù„Ø§ÙØªØ§Øª</h3>
                    <p class="text-gray-600 text-sm mb-3">Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</p>
                    <div class="text-3xl font-bold text-green-600" id="signageScore">--</div>
                </div>

                <!-- Errors -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">âš ï¸ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h3>
                    <p class="text-gray-600 text-sm mb-3">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</p>
                    <div class="text-3xl font-bold text-red-600" id="errorRate">--</div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="bg-white rounded-xl shadow-xl p-8 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª | Recommendations
                </h2>
                <div id="recommendations" class="space-y-4"></div>
            </div>

            <!-- Heatmaps -->
            <div id="heatmapsSection" class="bg-white rounded-xl shadow-xl p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    ğŸ—ºï¸ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© | Heatmaps
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold mb-2">Betweenness (Ø§Ù„Ø§Ø®ØªÙ†Ø§Ù‚Ø§Øª)</h3>
                        <img id="heatmapBetweenness" class="w-full rounded-lg shadow" alt="Betweenness Heatmap">
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">Integration (Ø§Ù„ØªÙƒØ§Ù…Ù„)</h3>
                        <img id="heatmapIntegration" class="w-full rounded-lg shadow" alt="Integration Heatmap">
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">VGA (Ø§Ù„Ø±Ø¤ÙŠØ©)</h3>
                        <img id="heatmapVGA" class="w-full rounded-lg shadow" alt="VGA Heatmap">
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">Errors (Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)</h3>
                        <img id="heatmapErrors" class="w-full rounded-lg shadow" alt="Errors Heatmap">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://wfapi.aqeeli.com';
        let currentJobId = null;

        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('fileInput');
            const scale = document.getElementById('scaleInput').value;
            const nAgents = document.getElementById('agentsInput').value;
            const enableHeatmaps = document.getElementById('heatmapsCheckbox').checked;

            if (!fileInput.files[0]) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('scale', scale);
            formData.append('n_agents', nAgents);
            formData.append('enable_heatmaps', enableHeatmaps);

            try {
                const response = await axios.post(`${API_URL}/api/analyze/wayfinding`, formData);
                currentJobId = response.data.job_id;
                
                document.getElementById('progressSection').classList.remove('hidden');
                document.getElementById('resultsSection').classList.add('hidden');
                
                checkStatus();
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + error.message);
            }
        });

        async function checkStatus() {
            if (!currentJobId) return;

            try {
                const response = await axios.get(`${API_URL}/api/status/${currentJobId}`);
                const data = response.data;

                document.getElementById('progressBar').style.width = data.progress + '%';
                document.getElementById('progressMessage').textContent = data.message;

                if (data.status === 'completed') {
                    displayResults();
                } else if (data.status === 'failed') {
                    alert('ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ' + data.message);
                    document.getElementById('progressSection').classList.add('hidden');
                } else {
                    setTimeout(checkStatus, 2000);
                }
            } catch (error) {
                console.error('Error checking status:', error);
                setTimeout(checkStatus, 2000);
            }
        }

        async function displayResults() {
            try {
                const response = await axios.get(`${API_URL}/api/results/${currentJobId}`);
                const data = response.data;

                document.getElementById('progressSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');

                // WES Score
                const wesScore = data.summary.wes_score.toFixed(1);
                document.getElementById('wesScore').textContent = wesScore;
                document.getElementById('wesGrade').textContent = data.summary.grade;
                document.getElementById('wesIntegretation').textContent = data.summary.interpretation;

                // Metrics
                document.getElementById('ssIntegration').textContent = 
                    (data.space_syntax.integration.mean_integration * 100).toFixed(0) + '%';
                document.getElementById('vgaIntegration').textContent = 
                    (data.vga.summary_statistics.mean_visual_integration * 100).toFixed(0) + '%';
                document.getElementById('signageScore').textContent = 
                    data.signage.composite_signage_score.toFixed(0);
                
                // Calculate average errors
                const scenarios = Object.values(data.agent_simulation.scenarios);
                const avgErrors = scenarios.reduce((sum, s) => sum + s.aggregate_metrics.mean_errors, 0) / scenarios.length;
                document.getElementById('errorRate').textContent = avgErrors.toFixed(1);

                // Recommendations
                const recsDiv = document.getElementById('recommendations');
                recsDiv.innerHTML = '';
                data.recommendations.slice(0, 5).forEach(rec => {
                    const div = document.createElement('div');
                    div.className = 'border-r-4 border-indigo-500 bg-gray-50 p-4 rounded';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-bold">${rec.priority.toUpperCase()}</span>
                                <h4 class="font-bold text-lg mt-2">${rec.title.ar}</h4>
                                <p class="text-gray-600 mt-1">${rec.description.ar}</p>
                                <p class="text-sm text-gray-500 mt-2">
                                    ğŸ’° ${rec.estimated_cost} | â±ï¸ ${rec.implementation_time} | 
                                    ğŸ“ˆ +${rec.estimated_wes_impact.toFixed(1)} WES
                                </p>
                            </div>
                        </div>
                    `;
                    recsDiv.appendChild(div);
                });

                // Heatmaps
                if (data.heatmaps && Object.keys(data.heatmaps).length > 0) {
                    document.getElementById('heatmapBetweenness').src = 
                        `${API_URL}/api/heatmap/${currentJobId}/betweenness`;
                    document.getElementById('heatmapIntegration').src = 
                        `${API_URL}/api/heatmap/${currentJobId}/integration`;
                    document.getElementById('heatmapVGA').src = 
                        `${API_URL}/api/heatmap/${currentJobId}/vga`;
                    document.getElementById('heatmapErrors').src = 
                        `${API_URL}/api/heatmap/${currentJobId}/errors`;
                }

            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ' + error.message);
            }
        }
    </script>
</body>
</html>
